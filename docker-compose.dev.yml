services:
  # PostgreSQL Database Service
  postgres:
    image: postgres:16-alpine
    container_name: managertasks_postgres_db_dev
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-managertasks_db}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123456}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-managertasks_db}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - managertasks_dev_network
    restart: unless-stopped

  # Spring Boot API Service (Development with Hot Reload)
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: managertasks_api_dev
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-managertasks_db}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-admin}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-admin123456}
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver

      # JPA/Hibernate Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      SPRING_JPA_SHOW_SQL: "false"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_JDBC_BATCH_SIZE: "10"

      # DevTools Configuration
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_RESTART_POLL_INTERVAL: "1000"
      SPRING_DEVTOOLS_RESTART_QUIET_PERIOD: "400"

      # Server Configuration
      SERVER_PORT: 8080
      SERVER_SERVLET_CONTEXT_PATH: /

      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET:-devSecretKeyChangeInProduction}

      # Logging Configuration (More verbose for development)
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_MANAGERTASKS_API: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG

    ports:
      - "${API_PORT:-8080}:8080"

    # Mount source code for hot reload
    volumes:
      # Mount source code directory
      - ./ManagerTasks-Api/src:/app/src
      # Mount Maven cache for faster rebuilds
      - maven_cache_dev:/root/.m2/repository
      # Mount target for compiled classes
      - ./ManagerTasks-Api/target:/app/target

    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - managertasks_dev_network

    restart: unless-stopped

    # Remove health check for development (app restarts frequently with DevTools)
    # Uncomment if needed
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s

volumes:
  postgres_data_dev:
    driver: local
  maven_cache_dev:
    driver: local

networks:
  managertasks_dev_network:
    driver: bridge
